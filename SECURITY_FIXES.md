# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–å®Ÿè£…ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

## å®Ÿè£…çŠ¶æ³ (2025å¹´6æœˆ11æ—¥æ›´æ–°)

âœ… **å®Ÿè£…æ¸ˆã¿**:
- XSSè„†å¼±æ€§ã®ä¿®æ­£ï¼ˆinnerHTML â†’ textContentï¼‰
- å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆsanitizeInput, escapeHtml, sanitizeFormDataï¼‰
- Content Security Policyï¼ˆCSPï¼‰ã®è¨­å®š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã®æƒ…å ±éš è”½ï¼‰
- ç‰¹å®šã®ç¿»è¨³ã‚­ãƒ¼ã®ã¿HTMLè¨±å¯ï¼ˆthankyou.high.text3, text4ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆsecurity-logger.jsï¼‰
- XSS/SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è©¦è¡Œã®è‡ªå‹•æ¤œå‡º
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼š1åˆ†é–“ã§3å›ã¾ã§ï¼‰
- é–‹ç™º/æœ¬ç•ªç’°å¢ƒåˆ¤å®šã¨ç’°å¢ƒåˆ¥ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆutils.jsï¼‰
- **Google Apps Scriptå´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**ï¼ˆ2025å¹´1æœˆ11æ—¥å®Œäº†ï¼‰
  - ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ï¼ˆALLOWED_DOMAINSã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰
  - ã‚µãƒ¼ãƒãƒ¼å´ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1åˆ†é–“ã«3å›ã¾ã§ï¼‰
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼‰
  - IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ­ã‚°è¨˜éŒ²
  - ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®è‡ªå‹•æ¤œå‡ºã¨ãƒ–ãƒ­ãƒƒã‚¯

âš ï¸ **åˆ¶é™äº‹é …**:
- Google Apps Scriptã®CORSåˆ¶é™ã«ã‚ˆã‚Šã€Content-Type: text/plainã‚’ä½¿ç”¨
- GitHub Pagesã®åˆ¶é™ã«ã‚ˆã‚Šã€HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã¯è¨­å®šä¸å¯
- CSPã«script.googleusercontent.comã‚’è¿½åŠ ï¼ˆGoogle Apps Scriptã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œï¼‰

ğŸ”§ **ä»Šå¾Œã®æ¨å¥¨äº‹é …**:
- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ—ãƒ­ã‚­ã‚·ã®å®Ÿè£…ï¼ˆGoogle Apps Script URLã®éš è”½ï¼‰
  - PROXY_IMPLEMENTATION.mdã«å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆæ¸ˆã¿
  - Vercel Functionsã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ã‚’æ¨å¥¨
- é©åˆ‡ãªHTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®šï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®å…¥åŠ›æ¤œè¨¼ã®å®Ÿè£…

## ãƒ—ãƒ­ã‚­ã‚·ä»¥å¤–ã®é«˜å„ªå…ˆåº¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­– ğŸš¨

### 1. HTTPSå¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å®Ÿè£… âœ… å®Ÿè£…å®Œäº† (2025å¹´6æœˆ11æ—¥)
**ãƒªã‚¹ã‚¯**: ä¸­é–“è€…æ”»æ’ƒã€ãƒ‡ãƒ¼ã‚¿å‚å—ã®å¯èƒ½æ€§

**å®Ÿè£…æ¸ˆã¿**:
- index.htmlã®<head>ã‚¿ã‚°å†…ã«HTTPSå¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 
- localhostã¨127.0.0.1ã‚’é™¤å¤–ã—ã¦é–‹ç™ºç’°å¢ƒã§ã®å‹•ä½œã‚’ä¿è¨¼
- HTTPã‚¢ã‚¯ã‚»ã‚¹ã¯è‡ªå‹•çš„ã«HTTPSã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

```javascript
// index.htmlã®<head>æœ€ä¸Šéƒ¨ã«å®Ÿè£…æ¸ˆã¿
<script>
  if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
    location.replace('https:' + window.location.href.substring(window.location.protocol.length));
  }
</script>
```

### 2. CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰ä¿è­· âœ… å®Ÿè£…å®Œäº† (2025å¹´6æœˆ11æ—¥)
**ãƒªã‚¹ã‚¯**: å¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰ã®ä¸æ­£ãªãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡

**å®Ÿè£…æ¸ˆã¿**:
- validation.jsã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼ãƒ»å–å¾—é–¢æ•°ã‚’è¿½åŠ 
- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«è‡ªå‹•çš„ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒä»˜ä¸ã•ã‚Œã‚‹
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ç®¡ç†

```javascript
// validation.js ã«å®Ÿè£…æ¸ˆã¿
function generateCSRFToken() {
  const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
  sessionStorage.setItem('csrfToken', token);
  return token;
}

function validateCSRFToken(token) {
  const storedToken = sessionStorage.getItem('csrfToken');
  return token === storedToken;
}

function getCSRFToken() {
  let token = sessionStorage.getItem('csrfToken');
  if (!token) {
    token = generateCSRFToken();
  }
  return token;
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«è‡ªå‹•çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¿½åŠ ã•ã‚Œã‚‹
dataObj.csrfToken = getCSRFToken();
```

### 3. å…¥åŠ›æ¤œè¨¼ã®å¼·åŒ– ğŸŸ¡
**ãƒªã‚¹ã‚¯**: ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡Œ

**å®Ÿè£…æ–¹æ³•**:
```javascript
// validation.js ã«è¿½åŠ 
const INPUT_LIMITS = {
  name: { min: 1, max: 100 },
  email: { min: 5, max: 254 },
  feedback: { min: 0, max: 1000 },
  phone: { min: 10, max: 15 }
};

function validateInputLength(input, field) {
  const limits = INPUT_LIMITS[field];
  if (!limits) return true;
  
  const length = input.length;
  if (length < limits.min || length > limits.max) {
    throw new Error(`${field} must be between ${limits.min} and ${limits.max} characters`);
  }
  return true;
}

// ç‰¹æ®Šæ–‡å­—ã®å³å¯†ãªæ¤œè¨¼
function validateSpecialCharacters(input, field) {
  const patterns = {
    name: /^[a-zA-Z\s\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\u3400-\u4dbf]+$/,
    email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
    phone: /^[\d\s\-\+\(\)]+$/
  };
  
  if (patterns[field] && !patterns[field].test(input)) {
    throw new Error(`Invalid characters in ${field}`);
  }
  return true;
}
```

### 4. CSPå¼·åŒ–ï¼ˆunsafe-inlineã®å‰Šé™¤ï¼‰ ğŸŸ¡
**ãƒªã‚¹ã‚¯**: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹XSSæ”»æ’ƒ

**å®Ÿè£…æ–¹æ³•**:
```html
<!-- index.html - nonceãƒ™ãƒ¼ã‚¹ã®CSPã«å¤‰æ›´ -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'nonce-{RANDOM_NONCE}' https://cdn.jsdelivr.net; 
               style-src 'self' 'nonce-{RANDOM_NONCE}' https://fonts.googleapis.com;">

<!-- ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«nonceã‚’è¿½åŠ  -->
<script nonce="{RANDOM_NONCE}">
  // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
</script>
```

### 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å®Ÿè£… ğŸŸ 
**ãƒªã‚¹ã‚¯**: é‡è¤‡é€ä¿¡ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡Œ

**å®Ÿè£…æ–¹æ³•**:
```javascript
// session-manager.jsï¼ˆæ–°è¦ä½œæˆï¼‰
class SessionManager {
  constructor() {
    this.sessionId = this.generateSessionId();
    this.submissions = [];
  }
  
  generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
  }
  
  canSubmit() {
    const now = Date.now();
    const recentSubmission = this.submissions.find(s => now - s < 60000); // 1åˆ†ä»¥å†…
    return !recentSubmission;
  }
  
  recordSubmission() {
    this.submissions.push(Date.now());
    // å¤ã„è¨˜éŒ²ã‚’å‰Šé™¤ï¼ˆãƒ¡ãƒ¢ãƒªç®¡ç†ï¼‰
    this.submissions = this.submissions.filter(s => Date.now() - s < 3600000); // 1æ™‚é–“
  }
}
```

### 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Œå…¨æ€§å‘ä¸Š ğŸŸ 
**ãƒªã‚¹ã‚¯**: æŠ€è¡“çš„è©³ç´°ã®æ¼æ´©ã€æ”»æ’ƒè€…ã¸ã®æƒ…å ±æä¾›

**å®Ÿè£…æ–¹æ³•**:
```javascript
// utils.js ã«è¿½åŠ 
function safeErrorHandler(error, context) {
  // é–‹ç™ºç’°å¢ƒã®ã¿è©³ç´°ãƒ­ã‚°
  if (isDevelopment()) {
    console.error(`Error in ${context}:`, error);
  } else {
    // æœ¬ç•ªç’°å¢ƒã§ã¯æ±ç”¨ã‚¨ãƒ©ãƒ¼ã®ã¿
    console.error(`Error in ${context}`);
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å¸¸ã«æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  return i18next.t('errors.generic');
}

// ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å®‰å…¨ãªå‡¦ç†
async function safeFetch(url, options) {
  try {
    const response = await fetch(url, options);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response;
  } catch (error) {
    // æŠ€è¡“çš„è©³ç´°ã‚’éš ã™
    throw new Error('Network request failed');
  }
}
```

## å„ªå…ˆåº¦: é«˜ ğŸ”´

### 1. Google Apps Script URLã®ä¿è­· âœ… å®Ÿè£…å®Œäº†

**ç¾çŠ¶**: config.jsã«Webã‚¢ãƒ—ãƒªURLãŒéœ²å‡ºã—ã¦ã„ã‚‹ãŒã€Google Apps Scriptå´ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–æ¸ˆã¿

**å®Ÿè£…æ¸ˆã¿**:
- âœ… .env.exampleãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
- âœ… .gitignoreã«ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
- âœ… PROXY_IMPLEMENTATION.mdã«è©³ç´°ãªå®Ÿè£…ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆ
- âœ… **Google Apps Scriptå´ã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…**ï¼ˆ2025å¹´6æœˆ11æ—¥ï¼‰
  - ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šï¼ˆALLOWED_DOMAINSï¼‰
  - ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™
  - ã‚µãƒ¼ãƒãƒ¼å´ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆIPå˜ä½ã§1åˆ†é–“3å›ï¼‰
  - ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®æ¤œå‡ºã¨ãƒ­ã‚°è¨˜éŒ²

**æ¨å¥¨äº‹é …**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:
- Vercel Functionsã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã§URLã‚’å®Œå…¨ã«éš è”½
- config.jsã®æ›´æ–°ï¼ˆãƒ—ãƒ­ã‚­ã‚·URLã¸ã®å¤‰æ›´ï¼‰

```javascript
// Step 2: .envãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
GOOGLE_APPS_SCRIPT_URL=your_actual_url_here
```

```javascript
// Step 3: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ—ãƒ­ã‚­ã‚·ã®å®Ÿè£… (proxy-server.js)
const express = require('express');
const app = express();
require('dotenv').config();

app.post('/api/submit-survey', async (req, res) => {
  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  // Google Apps Scriptã¸ã®è»¢é€
});
```

```javascript
// Step 4: config.jsã®ä¿®æ­£
const API_CONFIG = {
  WEBHOOK_URL: '/api/submit-survey', // ãƒ—ãƒ­ã‚­ã‚·ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›´
  // ...
};
```

### 2. XSSè„†å¼±æ€§ã®ä¿®æ­£ âœ… å®Ÿè£…å®Œäº†

**ç¾çŠ¶ã®å•é¡Œ**: innerHTMLä½¿ç”¨ã«ã‚ˆã‚‹è„†å¼±æ€§

**å®Ÿè£…æ¸ˆã¿**:
- âœ… ã™ã¹ã¦ã®innerHTMLã‚’textContentã«ç½®æ›
- âœ… ç‰¹å®šã®å®‰å…¨ãªç¿»è¨³ã‚­ãƒ¼ã®ã¿ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŒ–
- âœ… XSSè©¦è¡Œã®è‡ªå‹•æ¤œå‡ºæ©Ÿèƒ½ã‚’è¿½åŠ 

**å¯¾ç­–æ‰‹é †**:

```javascript
// Step 1: main.js (153è¡Œç›®ä»˜è¿‘) ã®ä¿®æ­£
// å¤‰æ›´å‰:
document.getElementById(elementId).innerHTML = message;

// å¤‰æ›´å¾Œ:
document.getElementById(elementId).textContent = message;
```

```javascript
// Step 2: i18n.js (40è¡Œç›®ä»˜è¿‘) ã®ä¿®æ­£
// å¤‰æ›´å‰:
element.innerHTML = i18next.t(translationKey);

// å¤‰æ›´å¾Œ:
element.textContent = i18next.t(translationKey);
```

```javascript
// Step 3: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ã®è¿½åŠ  (utils.js)
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
```

### 3. å…¥åŠ›æ¤œè¨¼ã®å¼·åŒ– âœ… å®Ÿè£…å®Œäº†

**å®Ÿè£…æ¸ˆã¿**:
- âœ… sanitizeInputé–¢æ•°ã«è„…å¨æ¤œå‡ºæ©Ÿèƒ½ã‚’çµ±åˆ
- âœ… XSS/SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è‡ªå‹•æ¤œå‡º
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚°è¨˜éŒ²
- âœ… **Google Apps Scriptå´ã§ã®æ¤œè¨¼**ï¼ˆ2025å¹´1æœˆ11æ—¥ï¼‰
  - å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚µãƒ¼ãƒãƒ¼å´ãƒã‚§ãƒƒã‚¯
  - ãƒ‡ãƒ¼ã‚¿å‹ã®æ¤œè¨¼
  - å…¥åŠ›å€¤ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆè©•ä¾¡å€¤1-5ãªã©ï¼‰

**å¯¾ç­–æ‰‹é †**:

```javascript
// Step 1: ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé–¢æ•°ã®è¿½åŠ  (validation.js)
function sanitizeInput(input) {
  // ç‰¹æ®Šæ–‡å­—ã®é™¤å»
  return input.trim().replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
}

// Step 2: å„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’é©ç”¨
function validateAndSanitizeForm(formData) {
  const sanitizedData = {};
  for (const [key, value] of Object.entries(formData)) {
    sanitizedData[key] = sanitizeInput(value);
  }
  return sanitizedData;
}
```

```javascript
// Step 3: ã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼ã®å®Ÿè£… (proxy-server.js)
function validateServerSide(data) {
  const errors = [];
  
  // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  if (!data.store || !['ilhair', 'ilmake', 'quarter', 'lim', 'ivil'].includes(data.store)) {
    errors.push('Invalid store');
  }
  
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
  if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
    errors.push('Invalid email');
  }
  
  // è©•ä¾¡å€¤æ¤œè¨¼
  if (data.overallRating && (data.overallRating < 1 || data.overallRating > 5)) {
    errors.push('Invalid rating');
  }
  
  return errors;
}
```

## å„ªå…ˆåº¦: ä¸­ ğŸŸ¡

### 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Ÿè£… âœ… éƒ¨åˆ†çš„ã«å®Ÿè£…

**å¯¾ç­–æ‰‹é †**:

âš ï¸ **GitHub Pagesã®åˆ¶é™**: HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã§ããªã„ãŸã‚ã€ä¸€éƒ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã¯é©ç”¨ã§ãã¾ã›ã‚“ã€‚

```html
<!-- Step 1: index.htmlã®headã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ï¼ˆCSPã®ã¿æœ‰åŠ¹ï¼‰ -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src 'self' https://fonts.gstatic.com;
               img-src 'self' data:;
               connect-src 'self' https://script.google.com;">
```

**ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§å®Ÿè£…å¯èƒ½ãªãƒ˜ãƒƒãƒ€ãƒ¼**:
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY
- X-XSS-Protection: 1; mode=block
- Strict-Transport-Security: max-age=31536000

```javascript
// Step 2: ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š (proxy-server.js)
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  next();
});
```

### 5. CORSè¨­å®šã®é©åˆ‡ãªå®Ÿè£… âš ï¸ åˆ¶é™äº‹é …ã‚ã‚Š

**ç¾çŠ¶ã®å•é¡Œ**: text/plainã§CORSã‚’å›é¿

**å¯¾ç­–æ‰‹é †**:

âš ï¸ **é‡è¦ãªåˆ¶é™**: Google Apps Scriptã¯CORSãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€
Content-Typeã‚’application/jsonã«è¨­å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

**ä¸€æ™‚çš„ãªå¯¾å¿œ**:
```javascript
// Google Apps Scriptã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹é–“ã¯ã€Content-Typeã‚’æŒ‡å®šã—ãªã„
fetch(apiUrl, {
  method: 'POST',
  body: JSON.stringify(dataObj) // text/plainã¨ã—ã¦é€ä¿¡
})
```

**æ¨å¥¨ã•ã‚Œã‚‹è§£æ±ºç­–**:
1. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ—ãƒ­ã‚­ã‚·ã‚’å®Ÿè£…ã—ã¦Google Apps Script URLã‚’éš è”½
2. ãƒ—ãƒ­ã‚­ã‚·å´ã§é©åˆ‡ãªCORSè¨­å®šã‚’å®Ÿè£…

```javascript
// Step 2: ã‚µãƒ¼ãƒãƒ¼å´ã§ã®CORSè¨­å®š (proxy-server.js)
const cors = require('cors');

app.use(cors({
  origin: ['https://yourdomain.com', 'http://localhost:8000'],
  credentials: true,
  methods: ['GET', 'POST'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
```

## å„ªå…ˆåº¦: ä½ ğŸŸ¢

### 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ âœ… å®Ÿè£…å®Œäº†

**å®Ÿè£…æ¸ˆã¿**:
- âœ… ç’°å¢ƒåˆ¤å®šæ©Ÿèƒ½ï¼ˆisDevelopmenté–¢æ•°ï¼‰
- âœ… é–‹ç™ºç’°å¢ƒã§ã®ã¿è©³ç´°ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- âœ… APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã¨ã®çµ±åˆ

**å¯¾ç­–æ‰‹é †**:

```javascript
// Step 1: è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã®éš è”½ (main.js)
// å¤‰æ›´å‰:
console.error('Error details:', error);
alert(`Error: ${error.message}`);

// å¤‰æ›´å¾Œ:
console.error('Submission failed');
if (process.env.NODE_ENV === 'development') {
  console.error('Error details:', error);
}
alert(i18next.t('errors.generic'));
```

```javascript
// Step 2: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å®Ÿè£…
function logSecurityEvent(eventType, details) {
  // ã‚µãƒ¼ãƒãƒ¼ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
  fetch('/api/security-log', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ eventType, details, timestamp: new Date() })
  });
}
```

## å®Ÿè£…çŠ¶æ³ã‚µãƒãƒªãƒ¼

### âœ… å®Œäº†ã—ãŸé …ç›®
1. XSSè„†å¼±æ€§ã®ä¿®æ­£ï¼ˆinnerHTML â†’ textContentï¼‰
2. å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ©Ÿèƒ½ã®å®Ÿè£…ã¨å¼·åŒ–
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼š1åˆ†é–“ã«3å›ã¾ã§ï¼‰
5. ç’°å¢ƒåˆ¥ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
6. CSPã®è¨­å®šï¼ˆãƒ¡ã‚¿ã‚¿ã‚°çµŒç”±ï¼‰
7. **Google Apps Scriptå´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**ï¼ˆ2025å¹´1æœˆ11æ—¥ï¼‰
   - ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã¨ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
   - ã‚µãƒ¼ãƒãƒ¼å´ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆIPå˜ä½ï¼‰
   - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¨ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½
8. **HTTPSå¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**ï¼ˆ2025å¹´1æœˆ11æ—¥ï¼‰
   - HTTPã‚¢ã‚¯ã‚»ã‚¹ã‚’è‡ªå‹•çš„ã«HTTPSã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   - é–‹ç™ºç’°å¢ƒï¼ˆlocalhostï¼‰ã‚’é™¤å¤–
9. **CSRFä¿è­·ã®å®Ÿè£…**ï¼ˆ2025å¹´1æœˆ11æ—¥ï¼‰
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
   - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ä¸

### âš ï¸ åˆ¶é™äº‹é …
1. HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆGitHub Pagesåˆ¶é™ï¼‰
2. CORSè¨­å®šï¼ˆGoogle Apps Scriptåˆ¶é™ï¼‰

### ğŸ”§ ä»Šå¾Œã®æ¨å¥¨äº‹é …ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
1. **Vercel Functionsãƒ—ãƒ­ã‚­ã‚·ã®å®Ÿè£…**
   - PROXY_IMPLEMENTATION.mdã«å¾“ã£ã¦å®Ÿè£…
   - Google Apps Script URLã‚’å®Œå…¨ã«éš è”½ï¼ˆç¾åœ¨ã¯GASå´ã§ä¿è­·æ¸ˆã¿ï¼‰
   
2. **è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆ**
   - SECURITY_TEST_GUIDE.mdã«åŸºã¥ãE2Eãƒ†ã‚¹ãƒˆ
   - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

3. **è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤**
   - WAFï¼ˆWeb Application Firewallï¼‰ã®å°å…¥
   - DDoSå¯¾ç­–ã®å¼·åŒ–

## ãƒ†ã‚¹ãƒˆé …ç›®

- [x] XSSæ”»æ’ƒã®ãƒ†ã‚¹ãƒˆï¼ˆ`<script>alert('XSS')</script>`ã‚’å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›ï¼‰
- [x] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆï¼ˆ`'; DROP TABLE--`ãªã©ã®å…¥åŠ›ï¼‰
- [x] ä¸æ­£ãªAPIç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ†ã‚¹ãƒˆï¼ˆç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
- [x] CSPãƒ˜ãƒƒãƒ€ãƒ¼ã®å‹•ä½œç¢ºèª
- [x] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é©åˆ‡æ€§ç¢ºèª
- [x] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å‹•ä½œç¢ºèªï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ»ã‚µãƒ¼ãƒãƒ¼å´ä¸¡æ–¹ï¼‰
- [x] Google Apps Scriptã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™æ©Ÿèƒ½ã®ç¢ºèª

## å‚è€ƒè³‡æ–™

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [Express.js Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)